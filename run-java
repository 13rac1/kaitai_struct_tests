#!/bin/sh -e

. ./config

JAVA_CLASSES_DIR=$(pwd)/compiled/java/bin

# Compile everything:
# 1. KS runtime part for Java
# 2. Binary format parser sources, generated by KS compiler
# 3. Test specs

mkdir -p "$JAVA_CLASSES_DIR"
javac -cp $JAVA_TESTNG_JAR \
	"$JAVA_RUNTIME_DIR/src/io/kaitai/struct/"*.java \
	compiled/java/src/io/kaitai/struct/testformats/*.java \
	spec/java/src/io/kaitai/struct/spec/*.java \
	-d "$JAVA_CLASSES_DIR"

# Actually run the tests
cd spec/java
java -cp "$JAVA_CLASSES_DIR:$JAVA_TESTNG_JAR" \
	org.testng.TestNG -testclass io.kaitai.struct.spec.SpecTests -d ../../test_out
