#!/bin/sh -e

. ./config

if [ "$#" -ne 3 ]; then
	echo "$0 <src_dir> <spec_dir> <test_out_dir>"
	exit 1
fi

SRC_DIR="$1"
CPP_SPEC_DIR="$2"
CPP_TEST_OUT_DIR="$3"

OBJ_DIR="$SRC_DIR/bin"
TEST_DIR=$(pwd)

# Compile everything:
# 1. KS runtime part for C++/STL
# 2. Binary format parser sources, generated by KS compiler
# 3. Test specs

#rm -rf "$OBJ_DIR"
mkdir -p "$OBJ_DIR"
cd "$OBJ_DIR"
if [ ! -r Makefile ] && [ ! -r KS_TEST_CPP_STL.sln ]; then
	echo "Using KS_CMAKE_OPTIONS=<$KS_CMAKE_OPTIONS>"
	cmake -DCMAKE_BUILD_TYPE=Debug -DKS_PATH="$SRC_DIR" "$KS_CMAKE_OPTIONS" "$CPP_SPEC_DIR"
fi

if [ -r Makefile ]; then
	make -j8
elif [ -r KS_TEST_CPP_STL.sln ]; then
	msbuild
else
	echo "No build makefile/project file found, unable to continue."
	ls -al
	exit 1
fi

# Work around boost v1.62 bug: https://svn.boost.org/trac10/ticket/12507
# --log_sink is broken in boost v1.62, using workaround, as per
# https://stackoverflow.com/a/39999085/487064
#
# However, Travis has boost v1.54, which has problems with it, so we
# won't use the workaround on anything except exactly v1.62

if [ -r /usr/include/boost/version.hpp ] && grep -q 'BOOST_VERSION 106200' /usr/include/boost/version.hpp; then
	# Boost v1.62 detected, enabling workaround
	BOOST_LOG_OPTION=--logger=JUNIT,test_suite,"$CPP_TEST_OUT_DIR/results.xml"
else
	# No boost v1.62, we'll stick to standard which works with v1.54 too
	BOOST_LOG_OPTION=--log_sink="$CPP_TEST_OUT_DIR/results.xml"
fi

# Actually run the tests
cd "$TEST_DIR"
mkdir -p "$CPP_TEST_OUT_DIR"
"$OBJ_DIR/ks_tests" \
	--log_format=XML \
	$BOOST_LOG_OPTION \
	--log_level=all \
	--report_level=detailed
